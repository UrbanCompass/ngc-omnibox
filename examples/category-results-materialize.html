<!DOCTYPE html>
<html ng-app="demoApp">
  <head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.8/css/materialize.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <style>
      ngc-omnibox-suggestions,
      ngc-omnibox-choices {
        display: block;
      }
    </style>
  </head>
  <body>
    <main class="container" ng-controller="OmniboxExampleController as demo">
      <h1>Categorized Results Omnibox Example</h1>
      <h2>Search For a Car Make by Country</h2>
      <p>Model value: {{demo.model}}</p>

      <ngc-omnibox
          ng-model="demo.model"
          placeholder="Enter a car make (e.g. Ford)"
          autofocus="true"
          is-selectable="demo.isSelectable(suggestion)"
          can-show="demo.shouldShowSuggestions(query)"
          multiple="true"
          source="demo.sourceFn(query)">

        <ngc-omnibox-field type="text"></ngc-omnibox-field>

        <ngc-omnibox-choices class="chips">
          <div class="chip">
            {{selection.make_display}}
            <i class="close material-icons" ng-click="omnibox.unchoose(selection)">
              close
            </i>
          </div>
        </ngc-omnibox-choices>

        <ngc-omnibox-suggestions class="collection with-header">

          <dl ngc-omnibox-suggestion-category>
            <dt class="collection-header">
              <h5 ngc-omnibox-suggestion-header class="collection-item"
                  ng-class="{'active': omnibox.isHighlighted(suggestion)}">
                {{suggestion.make_country}}
              </h5>
            </dt>
            <dd>
              <div ngc-omnibox-suggestion-item class="collection-item"
                  ng-class="{'active': omnibox.isHighlighted(suggestion)}">
                {{suggestion.make_display}}
              </div>
            </dd>
          </dl>

          <div ngc-omnibox-suggestion-loading class="progress">
            <div class="indeterminate"></div>
          </div>

          <div ngc-omnibox-suggestion-empty class="center-align">
            <span class="blue-grey-text text-lighten-3">No results...</span>
          </div>

        </ngc-omnibox-suggestions>
      </ngc-omnibox>
    </main>

    <script src="../dist/ngc-omnibox.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/2.5.0/fuse.min.js"></script>
    <script type="text/javascript">
      angular
        .module('demoApp', ['ngc.omnibox'])
        .config(function($sceDelegateProvider) {
          $sceDelegateProvider.resourceUrlWhitelist([
            'self',
            'http://www.carqueryapi.com/api/0.3/**'
          ]);
        })
        .controller('OmniboxExampleController', function ($http, $q, $scope) {
          var demo = this;
          var fuse;

          // Loads the remote data and populates the search engine
          function populateSearch() {
            return $q(function (resolve) {
              if (fuse) {
                resolve(fuse);
              } else {
                $http.jsonp('http://www.carqueryapi.com/api/0.3/?cmd=getMakes', {
                  jsonpCallbackParam: 'callback'
                })
                .then(function (response) {
                  fuse = new Fuse(response.data.Makes, {keys: ['make_display'], threshold: 0.3});
                  resolve(fuse);
                });
              }
            });
          };

          // Takes results from JSON API and categorizes the results by `make_country`
          function formatResults(results) {
            const grouped = {};

            // Populate groups with results
            results.forEach((result) => {
              const groupName = result.make_country;
              if (!grouped[groupName]) {
                grouped[groupName] = {
                  make_country: result.make_country,
                  children: []
                };
              }

              grouped[groupName].children.push(result);
            });

            return Object.keys(grouped).map((groupName) => grouped[groupName]);
          };

          this.model = [];

          // Only allow items, and not category headers, to be selectable
          this.isSelectable = function (item) {
            return !item.children;
          };

          // Only show suggestions when at least 2 characters have been entered
          this.shouldShowSuggestions = function (query) {
            return query.length >= 2;
          };

          this.sourceFn = function (query) {
            if (query) {
              return populateSearch().then(function (fuse) {
                const searchResults = fuse.search(query).filter(function (result) {
                  return !demo.model.includes(result);
                });
                return $q.resolve(formatResults(searchResults));
              });
            } else {
              return $q.resolve(); // Hides the suggestions
            }
          };
        });
    </script>
  </body>
</html>
